<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Monkey</title>
    <meta charset="utf-8"/>
    <meta property="og:image" content="http://shallaa.github.io/SoftEngine/og/2.jpg"/>
    <meta property="og:title" content="Monkey"/>
    <meta property="og:description" content="MoGL.js version"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=high-dpi "/>
    <style>
        html, body {
            background-color: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        .FPS {
            color: #FFF;
            left: 0px;
            top: 0px;
            position: absolute;
        }
    </style>
    <script src="../src/$.js"></script>
    <script src="../src/MoGL.js"></script>
    <script src="../src/BlendMode.js"></script>
    <script src="../src/Filter.js"></script>
    <script src="../src/Primitive.js"></script>
    <script src="../src/Vertex.js"></script>
    <script src="../src/Shading.js"></script>
    <script src="../src/VertexShaderFunctions.js"></script>
    <script src="../src/Shader.js"></script>
    <script src="../src/Matrix.js"></script>
    <script src="../src/Texture.js"></script>
    <script src="../src/Geometry.js"></script>
    <script src="../src/Material.js"></script>
    <script src="../src/Mesh.js"></script>
    <script src="../src/Group.js"></script>
    <script src="../src/Camera.js"></script>
    <script src="../src/Scene.js"></script>
    <script src="../src/World.js"></script>
</head>
<body>
<img src="monkey/Suzanne.jpg" id="testIMG2" style="position: absolute;top:0px; display:none" width="256" height="256">
<canvas id="canvas"></canvas>
<div class="FPS" style="position: absolute;top:0px;">
    Current FPS: <span id="currentFPS"></span>
    Average FPS: <span id="averageFPS"></span>
</div>
<script>
    'use strict';

    var world = new World('canvas');
    var scene = new Scene();
    var divCurrentFPS = document.getElementById('currentFPS');
    var divAverageFPS = document.getElementById('averageFPS');

    var material = new Material('#fff')
    var texture = new Texture()
    world.setAutoSize(1)
    world.addScene(scene);
    texture.img = document.getElementById('testIMG2')
    //
    var camera = new Camera()
    scene.addChild(camera);
    scene.addMaterial(material.setId('material'));
    //
    //    material.addTexture(Texture.diffuse, texture);
    //    material.shading = Shading.phong

    var xmlhttp = new XMLHttpRequest();

    xmlhttp.open('GET', 'monkey/monkey.babylon', true);
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            start(JSON.parse(xmlhttp.responseText));
        }
    };
    xmlhttp.send(null);

    function start(json) {
        var mesh = json.meshes[0];
        var vertices = mesh.vertices;
        var indices = mesh.indices;
        var uvCount = mesh.uvCount;
        var verticesStep = 1;

        switch (uvCount) {
            case 0:
                verticesStep = 6;
                break;
            case 1:
                verticesStep = 8;
                break;
            case 2:
                verticesStep = 10;
                break;
        }

        var verticesCount = vertices.length / verticesStep;
        var facesCount = indices.length / 3;
        var vertex = [];
        var index = [];
        var i = 0;
        var j;

        for (; i < verticesCount; i++) {
            j = i * verticesStep;

            vertex.push(vertices[j], vertices[j + 1], vertices[j + 2], vertices[j + 3], vertices[j + 4], vertices[j + 5]);

            if (uvCount > 0) {
                vertex.push(vertices[j + 6], vertices[j + 7]);
            } else {
                vertex.push(0, 0);
            }
        }

        for (i = 0; i < facesCount; i++) {
            j = i * 3;

            index.push(indices[j], indices[j + 1], indices[j + 2]);
        }

        var geo = new Geometry(vertex, index, [Vertex.x, Vertex.y, Vertex.z, Vertex.normalX, Vertex.normalY, Vertex.normalZ, Vertex.u, Vertex.v]).setId('geometry')

        var meshes = [];
        var monkey;
        var PI2 = Math.PI * 2;

        for (i = 0; i < 500; i++) {
            var a = new Material('#' + (0xffffff * Math.random().toString()))
            if (i % 5 == 0) a.addTexture(Texture.diffuse, texture)
//            a.addTexture(Texture.diffuse,texture)
            monkey = new Mesh(geo, a);
            a.shading = Shading.phong
            monkey.x = Math.random() * 50 - 25;
            monkey.y = Math.random() * 50 - 25;
            monkey.z = Math.random() * 50 - 25;
//            monkey.z = Math.random() * 50 - 25;
            monkey.rotateX = Math.random() * PI2;
            monkey.rotateY = Math.random() * PI2;
            monkey.rotateZ = Math.random() * PI2;

            scene.addChild(monkey);
            meshes.push(monkey);


        }
//        monkey = new Mesh(Primitive.sphere(), material);
//        scene.addChild(monkey);
////        monkey.setScale(3, 3, 3)
//
//        monkey = new Mesh(Primitive.sphere(), material);
//        scene.addChild(monkey);
////        monkey.setScale(2, 2, 2)
////        monkey.setPosition(-3, 0, 0)
//
//        monkey = new Mesh(Primitive.sphere(), material);
//        scene.addChild(monkey);
////        monkey.setScale(2, 2, 2)
////        monkey.setPosition(3, 0, 0)

        var prevTime = 0;
        var sum = 0, count = 1;

        world.addEventListener(World.renderBefore, function addRenderBefore(currTime) {

            var currentFPS = 1000 / ( currTime - prevTime );
            prevTime = currTime;


            count++
            divCurrentFPS.textContent = currentFPS.toFixed(2);
            divAverageFPS.textContent = ( ( sum += currentFPS ) / count ).toFixed(2);

            var i = meshes.length;

            var mesh;

            while (i--) {
                mesh = meshes[i];
                mesh.rotateX += 0.05;
                mesh.rotateY += 0.05;
                mesh.rotateZ += 0.05;
            }
            camera.x = Math.sin(count / 50) * 50
            camera.y = Math.cos(count / 100) * 50
            camera.z = Math.cos(count / 100) * 50 + Math.sin(count / 100) * 50
            camera.lookAt(0, 0, 0);
        })

        world.start()

//        function aa() {
//            var currTime = Date.now()
//
//            var currentFPS = 1000 / ( currTime - prevTime );
//            prevTime = currTime;
//
//            count++
//            divCurrentFPS.textContent = currentFPS.toFixed(2);
//            divAverageFPS.textContent = ( ( sum += currentFPS ) / count ).toFixed(2);
//
//            var i = 0;
//            var j = meshes.length;
//            var mesh;
//
//            for (; i < j; i++) {
//                mesh = meshes[i];
//                mesh.rotateX += 0.05;
//                mesh.rotateY += 0.05;
//                mesh.rotateZ += 0.05;
//            }
//            camera.x = Math.sin(count / 50) * 50
//            camera.y = Math.cos(count / 100) * 50
//            camera.z = Math.cos(count / 100) * 50 + Math.sin(count / 100) * 50
//            camera.lookAt(0, 0, 0);
//            world.render()
//        }
//
//        setInterval(aa, 16)
    }

</script>
</body>
</html>